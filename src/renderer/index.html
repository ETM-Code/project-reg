<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Reg</title>
  <link href="css/output.css" rel="stylesheet">
  <link href="css/themes.css" rel="stylesheet">
  <link href="css/animations.css" rel="stylesheet">
  <!-- Personality Selector CSS -->
  <link href="components/personalitySelector.css" rel="stylesheet">
  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- particles.js -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <!-- Swiper JS -->
  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
</head>
<body class="bg-[var(--background-color)] text-[var(--foreground-color)]">
  <!-- Expanded Input Overlay - MOVED HERE -->
  <div id="inputOverlay" class="fixed inset-0 bg-[var(--overlay-bg-color)] z-50 opacity-0 invisible transition-all duration-300 ease-in-out" style="--overlay-bg-color: rgba(0, 0, 0, 0.5); z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none;"> <!-- DIAGNOSTIC: Removed flex centering, kept explicit position/size -->
    <div id="inputOverlayBackdrop" class="absolute inset-0 backdrop-blur-sm transition-opacity duration-300 ease-in-out opacity-0"></div> <!-- Backdrop for blur -->
    <!-- DIAGNOSTIC: Removed most layout/sizing/transform classes -->
    <div id="expandedInputContainer" class="relative bg-[var(--content-bg-color)] p-6 rounded-lg shadow-xl">
      <button id="closeExpandedInputBtn" class="absolute top-2 right-2 btn-icon text-[var(--foreground-color-muted)] hover:text-[var(--foreground-color)]" aria-label="Close expanded input">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-lg font-semibold mb-4 text-[var(--foreground-color)]">Expanded Input</h3>
      <!-- Input area will be moved here by JS -->
      <div id="expandedInputTarget" class="flex-grow flex flex-col min-h-0">
        <!-- Dedicated Textarea and Send Button for Modal -->
        <div class="relative flex-grow flex flex-col"> <!-- Added flex container -->
          <textarea
            id="expandedUserInput"
            class="textarea-base flex-grow"
            rows="10"
            placeholder="Type your message (Shift+Enter for newline, Enter to send)..."
            style="min-height: 150px; height: 60vh; overflow-y: auto; padding-right: 0.5rem;"
          ></textarea>
          <button
            id="expandedSendBtn"
            class="btn-primary p-2 mt-2 self-end"
            style="background: var(--accent-gradient); --tw-shadow-color: var(--shadow-color);"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- END Expanded Input Overlay -->

  <div class="flex flex-col h-screen">
    <!-- Header: Apply shadow -->
    <div class="bg-[var(--header-bg-color)] text-[var(--header-text-color)] p-4 flex-shrink-0 flex justify-between items-center shadow-md" style="--tw-shadow-color: var(--shadow-color); box-shadow: 0 2px 4px -1px var(--shadow-color);">
      <div class="flex items-center space-x-3">
        <h1 class="text-2xl font-bold">Project Reg</h1>
        <!-- Model selector moved to the right side -->
      </div>
      <div class="flex items-center space-x-4">
        <!-- Token Counter Display -->
        <div id="tokenCounterDisplay" class="text-sm opacity-90">
          Today's Tokens: Loading...
        </div>

        <!-- Model Selector (Relocated & Labelled) -->
        <div class="flex items-center">
            <span class="text-sm font-medium mr-1 text-[var(--header-text-color)]/90">Model:</span>
            <div id="customModelSelector" class="relative">
              <button id="modelSelectorBtn" type="button" class="custom-select-button inline-flex items-center justify-between w-full rounded-md border border-transparent px-3 py-1 bg-white/10 text-[var(--header-text-color)]/90 hover:bg-white/20 focus:outline-none focus:ring-1 focus:ring-white/50 text-sm transition-colors">
                <span id="modelSelectorBtnText" class="truncate pr-1">Select Model</span>
                <svg class="ml-1 h-4 w-4 text-[var(--header-text-color)]/70 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
              <div id="modelSelectorDropdown" class="origin-top-left absolute left-0 mt-1 w-56 rounded-md shadow-lg bg-[var(--content-bg-color)] ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20 border border-[var(--border-color-soft)] max-h-60 overflow-y-auto custom-scrollbar" role="menu" aria-orientation="vertical" aria-labelledby="modelSelectorBtn">
                <div id="modelSelectorOptions" class="py-1" role="none">
                  <!-- Options will be populated by JS -->
                </div>
              </div>
            </div>
            <!-- Keep original select hidden -->
            <select id="modelSelector" class="hidden">
            </select>
        </div>

        <!-- Restyled Personality Button with Label -->
        <button id="openPersonalitySelectorBtn" class="inline-flex items-center rounded-md border border-transparent px-3 py-1 bg-white/10 text-[var(--header-text-color)]/90 hover:bg-white/20 focus:outline-none focus:ring-1 focus:ring-white/50 text-sm transition-colors" aria-label="Select Personality">
            <span class="text-sm font-medium mr-1">Personality:</span>
            <span id="active-personality-name" class="font-semibold truncate pr-1">Loading...</span> <!-- Re-using the ID from the old display div -->
            <i class="fas fa-edit ml-2 h-4 w-4 text-[var(--header-text-color)]/70 flex-shrink-0"></i> <!-- Changed icon -->
        </button>

        <!-- Settings Button -->
        <button id="settingsBtn" class="btn-header-icon" aria-label="Settings">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>

    <div class="flex flex-1 overflow-hidden"> <!-- Main content area -->

      <!-- Sidebar: Use softer border -->
      <div class="w-64 bg-[var(--sidebar-bg-color)] text-[var(--sidebar-text-color)] p-4 flex flex-col flex-shrink-0 border-r border-[var(--border-color-soft)]">
        <!-- New Chat Button: Apply gradient, rounded shape -->
        <button id="newChatBtn" class="btn-primary mb-4 w-full" style="background: var(--accent-gradient); --tw-shadow-color: var(--shadow-color);">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          New Chat
        </button>
        <h2 class="text-lg font-semibold mb-3 text-[var(--foreground-color)]">Saved Chats</h2>
        <div id="chatList" class="flex-1 overflow-y-auto space-y-1 pr-1 custom-scrollbar">
          <!-- Saved chats will be listed here -->
          <!-- JS applies styles like --chat-list-hover-bg, --chat-list-selected-bg, --chat-list-selected-text -->
        </div>
      </div>

      <!-- Chat Area -->
      <div class="flex flex-col flex-1 overflow-hidden p-2 relative bg-[var(--background-color)]">
        <!-- Loading Indicator removed from here -->

        <!-- Chat Window: Use softer border, custom scrollbar -->
        <div id="chatWindow" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[var(--content-bg-color)] rounded-lg shadow-inner mb-2 border border-[var(--border-color-soft)] custom-scrollbar" style="--tw-shadow-color: var(--shadow-color);">
          <!-- Chat messages get appended here -->
        </div>
        <!-- Input Area: Use softer border -->
        <div id="chatInputArea" class="p-4 border-t border-[var(--border-color-soft)] bg-[var(--background-color)] flex-shrink-0 rounded-b-lg flex items-end space-x-2">
          <!-- Model selector removed from here -->
          <!-- Expand Button -->
          <button id="expandInputBtn" class="btn-secondary p-2 self-stretch flex-shrink-0" aria-label="Expand input area" style="height: 42px;"> <!-- Match initial textarea height -->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
            </svg>
          </button>
          <!-- Textarea and Send Button Container -->
          <div class="relative flex-grow"> <!-- Removed flex items-end, added flex-grow -->
            <textarea
              id="userInput"
              class="textarea-base"
              rows="1"
              placeholder="Type your message (Shift+Enter for newline, Enter to send)..."
              style="padding-right: 3.5rem; min-height: 42px; max-height: 200px;"
            ></textarea>
            <!-- Send Button: Apply gradient, adjust position slightly -->
            <button
              id="sendBtn"
              class="absolute right-2 bottom-[9px] btn-primary p-2"
              style="background: var(--accent-gradient); --tw-shadow-color: var(--shadow-color);"
            >
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
              </svg>
            </button>
            <!-- Cancel Edit Button Placeholder -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <!-- Settings Modal: Uses new CSS classes for structure and state -->
  <div id="settingsModal"> <!-- Base container, controlled by CSS -->
      <div class="modal-content"> <!-- Flex container from CSS -->

          <!-- Modal Header -->
          <div class="modal-header">
              <h2 id="settingsModalTitle" class="modal-title">Settings</h2>
              <button id="closeSettingsBtn" class="modal-close-button" aria-label="Close settings">
                  <i class="fas fa-times"></i> <!-- Smaller icon if needed -->
              </button>
          </div>

          <!-- Modal Body (Scrollable) -->
          <div class="modal-body">

              <!-- General Settings Section -->
              <div class="settings-section">
                  <h3>General</h3>
                  <div class="form-group">
                      <label for="themeSelector">Color Theme</label>
                      <select id="themeSelector" class="select-base"> <!-- Use base class -->
                          <option value="default">Default</option>
                          <option value="light">Light</option>
                          <option value="dark">Dark</option>
                      </select>
                  </div>
              </div>

              <!-- Model Settings Section -->
              <div class="settings-section">
                  <h3>Model Settings</h3>
                  <div class="form-group">
                      <label for="globalModelSelector">Default AI Model</label>
                      <select id="globalModelSelector" class="select-base">
                          <!-- Options populated by settingsModal.js -->
                          <option value="">Loading models...</option>
                      </select>
                  </div>
                  <div id="reasoningEffortGroup" class="form-group hidden"> <!-- Hidden by default -->
                      <label for="reasoningEffortSelector">Reasoning Effort</label>
                      <select id="reasoningEffortSelector" class="select-base">
                          <option value="low">Low</option>
                          <option value="medium" selected>Medium</option> <!-- Default -->
                          <option value="high">High</option>
                      </select>
                      <p class="text-xs text-[var(--foreground-color-muted)] mt-1">Applies only to reasoning models (e.g., o4-mini).</p>
                  </div>
              </div>

              <!-- API Keys Section -->
              <div class="settings-section">
                  <h3>API Keys</h3>
                  <div class="form-group">
                      <label for="openaiApiKeyInput">OpenAI API Key</label>
                      <div class="flex items-center space-x-2">
                          <input type="password" id="openaiApiKeyInput" class="input-base flex-grow" placeholder="Enter your OpenAI key">
                          <button id="saveOpenaiApiKeyBtn" class="btn btn-secondary py-1.5 px-3 text-sm">Save</button> <!-- Consider btn-primary -->
                      </div>
                  </div>
                  <div class="form-group">
                      <label for="geminiApiKeyInput">Gemini API Key</label>
                      <div class="flex items-center space-x-2">
                          <input type="password" id="geminiApiKeyInput" class="input-base flex-grow" placeholder="Enter your Gemini key">
                          <button id="saveGeminiApiKeyBtn" class="btn btn-secondary py-1.5 px-3 text-sm">Save</button> <!-- Consider btn-primary -->
                      </div>
                  </div>
              </div>

              <!-- Personality Settings Section -->
              <div class="settings-section">
                  <h3>Personality Details</h3>
                  <div class="form-group">
                      <label id="personalitySelectorLabel" for="personalitySelectorContainer">Configure Personality</label>
                      <div id="personalitySelectorContainer" class="relative">
                          <!-- Custom dropdown will be initialized here by customDropdown.js -->
                          <select id="personalitySelector" class="hidden"></select> <!-- Hidden select stores value -->
                          <!-- Button and dropdown panel created by JS -->
                      </div>
                  </div>

                  <!-- Personality Details Sub-section (Initially Hidden) -->
                  <div id="personalityDetailsContainer" class="hidden space-y-4 mt-4 p-4 border border-[var(--border-color-soft)] rounded-lg bg-[var(--content-bg-color-alt)]">
                       <div class="form-group">
                           <label>Description</label>
                           <p id="personalityDescription" class="text-sm text-[var(--foreground-color-muted)] italic bg-[var(--input-bg-color)] p-2 rounded border border-[var(--input-border-color)] min-h-[40px]"></p>
                       </div>
                       <div class="form-group">
                          <label>Default Context Sets</label>
                          <div id="contextSetsContainer" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar border border-[var(--border-color-soft)] p-3 rounded bg-[var(--input-bg-color)]">
                              <!-- Checkboxes populated by JS using .checkbox-group -->
                          </div>
                      </div>
                      <div id="customInstructionsContainer" class="hidden form-group">
                          <label for="customInstructionsTextarea">Custom Instructions Override</label>
                          <textarea id="customInstructionsTextarea" class="textarea-base" rows="4" placeholder="Enter custom instructions for this personality..."></textarea>
                      </div>
                      <button id="savePersonalitySettingsBtn" class="btn btn-primary w-full mt-3 text-sm py-2" disabled>Save Personality Settings</button>
                  </div>
              </div>

          </div> <!-- End Modal Body -->

          <!-- Modal Footer -->
          <div class="modal-footer">
              <!-- Could add other buttons here if needed, e.g., a general "Close" -->
              <button type="button" class="btn btn-secondary" onclick="document.getElementById('settingsModal').classList.remove('open')">Close</button>
              <!-- Maybe move save buttons here? Or keep them contextual -->
          </div>

      </div> <!-- End Modal Content -->
  </div> <!-- End Settings Modal -->

  <!-- Personality Selector Component HTML (Initially Hidden) -->
  <!-- Placeholder for Personality Selector HTML -->
  <div id="personality-selector-overlay" class="personality-selector-overlay hidden">
    <div class="personality-selector-background"></div>
    <div class="personality-selector-container">
      <h2>Select Personality</h2>
      <!-- Carousel will go here -->
      <div id="personality-carousel" class="swiper-container">
          <div class="swiper-wrapper">
              <!-- Personality cards will be injected here by JS -->
          </div>
          <!-- Add Pagination -->
          <div class="swiper-pagination"></div>
          <!-- Add Navigation -->
          <div class="swiper-button-next"></div>
          <div class="swiper-button-prev"></div>
      </div>
      <button id="close-personality-selector">Close</button>
      <!-- Particle canvas (optional, depending on library) -->
      <div id="particles-js"></div>
    </div>
  </div>

  <!-- Component Scripts -->
  <script type="module" src="components/personalitySelector.js"></script> <!-- Load as module -->
  <script src="components/autoResizeInput.js"></script>
  <script src="components/loadingIndicator.js"></script>
  <script src="components/customDropdown.js"></script> <!-- Define initializeCustomDropdown first -->
  <script src="components/settingsModal.js"></script> <!-- Then load the script that uses it -->

  <!-- Main App Script (Load Last) -->
  <script type="module" src="app.js"></script> <!-- Load as module -->
  <script src="chatHistory.js"></script> <!-- Assuming this doesn't need module context -->

  <!-- Add class for custom scrollbars -->
  <style>
    .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: var(--scrollbar-track-color); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb-color); border-radius: 4px; border: 2px solid var(--scrollbar-track-color); }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: color-mix(in srgb, var(--scrollbar-thumb-color) 80%, black); }
    .custom-scrollbar::-webkit-scrollbar-corner { background: transparent; }
    /* For Firefox */
    .custom-scrollbar { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb-color) var(--scrollbar-track-color); }
  </style>

</body>
</html>
